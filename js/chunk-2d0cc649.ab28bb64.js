(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d0cc649"],{"4e79":function(s,a,r){"use strict";r.r(a);var e=function(){var s=this,a=s.$createElement;s._self._c;return s._m(0)},t=[function(){var s=this,a=s.$createElement,r=s._self._c||a;return r("section",[r("h1",[s._v("AWS S3 初探")]),r("p",[r("a",{attrs:{href:"https://amazonaws-china.com/cn/s3/"}},[s._v("Amazon Simple Storage Service (Amazon S3)")]),s._v(" 是一种对象存储服务，提供行业领先的可扩展性、数据可用性、安全性和性能。数据以对象的形式存储在名为“存储桶”的资源中，单个对象大小的上限为5TB。")]),r("h2",[s._v("费用计算方面")]),r("p",[s._v("AWS S3的费用主要由两部分构成：存储产生费用和数据上下行产生费用。")]),r("ul",[r("li",[s._v("根据文件所在的存储层级不同，每存储1G将产生不同的存储费用。")]),r("li",[s._v("根据文件传入传出大小，产生一定的传输费用。目前文件上传费用每 GB 0.00 USD，下载费用每月有 1 GB的费用豁免，传输数据量在 1 GB 到 5 TB之间时，每 GB 产生 0.09 USD的传出费用。")])]),r("p",[s._v("(其他关于S3的介绍有了相关研究再进行更新)")]),r("h2",[s._v("公开文件下载端口")]),r("p",[s._v("对于将AWS S3作为文件下载的仓库需求而言，想要使其可以被公开地下载，还需要费一番功夫。出于安全性考虑，默认的AWS S3中的文件都是非公开的。可以通过修改该设置达到公开文件下载链接，但也可以使用一种更安全的方式：预签名。")]),r("p",[s._v("预签名类似于，使用有权限下载文件的账号访问AWS S3，获取临时的下载链接，而后再将该链接传递给用户，从而达到文件的临时公开下载目的。接下来讲讲使用nodejs作为后端时如何进行预签名，相关API可以在"),r("a",{attrs:{href:"https://amazonaws-china.com/cn/sdk-for-node-js/"}},[s._v("这里")]),s._v("找到。")]),r("p",[s._v("同样基于安全性考虑，最好不是使用根用户，而是在IMA中专门注册一个用户用来预签名，在此不对具体操作进行赘述。而后在nodejs中实例化S3服务：")]),r("pre",{pre:!0},[r("code",{pre:!0,attrs:{"v-pre":"",class:"language-javascript"}},[r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// entry js: index.js, app.js etc")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("var")]),s._v(" AWS = "),r("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),r("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'aws-sdk'")]),s._v(");\n"),r("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("var")]),s._v(" s3 = "),r("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" AWS.S3(configs.aws.s3);\n")])]),r("p",[s._v("其中，"),r("code",{pre:!0},[s._v("config.aws.s3")]),s._v("是一个参数json，在我的应用中，包含如下参数。比较特别的两项有"),r("code",{pre:!0},[s._v("region")]),s._v("字段和"),r("code",{pre:!0},[s._v("signatureVersion")]),s._v("字段，他们分别的作用是指定发送请求给谁，以及签名版本。之所以指定签名版本是因为作为默认的'v2'版本是处于废弃状态的版本，部分region并不支持。")]),r("pre",{pre:!0},[r("code",{pre:!0,attrs:{"v-pre":"",class:"language-javascript"}},[r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// configs.aws.s3")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("s3")]),s._v(": {\n  "),r("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("apiVersion")]),s._v(": "),r("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'2006-03-01'")]),s._v(", "),r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("/*api version*/")]),s._v("\n  "),r("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("accessKeyId")]),s._v(": "),r("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'xxx'")]),s._v(",       "),r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("/*user's access key*/")]),s._v("\n  "),r("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("secretAccessKey")]),s._v(": "),r("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'xxx'")]),s._v(",   "),r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("/*user's secret access key*/")]),s._v("\n  "),r("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("region")]),s._v(": "),r("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'ap-east-1'")]),s._v(",      "),r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("/*bucket's region*/")]),s._v("\n  "),r("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("signatureVersion")]),s._v(": "),r("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'v4'")]),s._v("    "),r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("/*signature version*/")]),s._v("\n}\n")])]),r("p",[s._v("S3实例化后，就可以通过调用"),r("code",{pre:!0},[s._v("getSignedUrlPromise")]),s._v("API来进行预签名。一个典型的使用样例如下。")]),r("pre",{pre:!0},[r("code",{pre:!0,attrs:{"v-pre":"",class:"language-javascript"}},[r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// signedUrl request")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("var")]),s._v(" params = { \n  "),r("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("Bucket")]),s._v(": "),r("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'xxx'")]),s._v(",    "),r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("/* bucket name */")]),s._v("\n  "),r("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("Key")]),s._v(": "),r("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'xxx'")]),s._v(",       "),r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("/* key to the file */")]),s._v("\n  "),r("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("Expires")]),s._v(": "),r("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("10")]),s._v(" * "),r("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("60")]),s._v("  "),r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("/* expire time(s) */")]),s._v("\n};\n"),r("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("var")]),s._v(" promise = s3.getSignedUrlPromise("),r("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'getObject'")]),s._v(", params);\npromise.then("),r("span",{pre:!0,attrs:{class:"hljs-function"}},[r("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" ("),r("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("url")]),s._v(") ")]),s._v("{\n  "),r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// get url successful")]),s._v("\n  res.send({ url }).status("),r("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("200")]),s._v(").end();\n}, "),r("span",{pre:!0,attrs:{class:"hljs-function"}},[r("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" ("),r("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("err")]),s._v(") ")]),s._v("{\n  "),r("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// error handing")]),s._v("\n  "),r("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log(err);\n  res.status("),r("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("500")]),s._v(").end();\n});\n")])]),r("p",[s._v("由于跨域访问的问题，因此不直接使用"),r("code",{pre:!0},[s._v("redirect")]),s._v("，而是将url发送给前端，再由前端使用添加iframe元素等方式直接向S3服务器发送下载文件请求。该方法样例如下。")]),r("pre",{pre:!0},[r("code",{pre:!0,attrs:{"v-pre":"",class:"language-javascript"}},[r("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("var")]),s._v(" elemIF = "),r("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("document")]),s._v(".createElement("),r("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"iframe"')]),s._v(");\nelemIF.src = data.url;\nelemIF.style.display = "),r("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"none"')]),s._v(";\n"),r("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("document")]),s._v(".body.appendChild(elemIF);\n")])])])}],n=r("2877"),p={},l=Object(n["a"])(p,e,t,!1,null,null,null);a["default"]=l.exports}}]);
//# sourceMappingURL=chunk-2d0cc649.ab28bb64.js.map